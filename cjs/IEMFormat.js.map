{"version":3,"sources":["../build/IEMFormat.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","IEMFormat","shortName","getName","getDescription","container_type","ContainerType","JSON","test","obj","hasOwnProperty","Decoder","parse","filename","carry","add","ADD","name","Name","description","Description","author","date_str","split","trim","ampm","slice","date","Date","setHours","getHours","setDate","addMatrix","Matrix","ExpectedInputNormalization","num_outputs","LoudspeakerLayout","Loudspeakers","reduce","val","spk","IsImaginary","num_imags","decoder","output","matrix","push","Array","fill","forEach","speaker","index","addOutput","OutputChannel","coords","AEDCoord","Azimuth","Elevation","Radius","Routing","ch","Gain","valid","results","incomplete_results","fromADD","opts","iem","matrices","getNormalisation","Weights","WeightsAlreadyApplied","channels","a","e","isImag","Channel","gainForChannel","prettify","use","stringify","arr"],"mappings":"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","sourcesContent":["var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nimport { _static_implements, ContainerType } from './ADCFormat';\nimport { ADD, Matrix, OutputChannel, AEDCoord } from 'dotadd.js';\nlet IEMFormat = class IEMFormat {\n    static shortName() {\n        return \"iem\";\n    }\n    static getName() {\n        return \"IEM AllRad Decoder Configuration Files\";\n    }\n    static getDescription() {\n        return \"Exported and imported by the IEM Allrad decoder. Can also be read by the IEM Simple Decoder\";\n    }\n    static container_type() {\n        return ContainerType.JSON;\n    }\n    static test(obj) {\n        return obj.hasOwnProperty('Name')\n            && obj.hasOwnProperty(\"Description\")\n            && obj.hasOwnProperty(\"Decoder\")\n            && obj.Decoder.hasOwnProperty(\"Weights\");\n    }\n    static parse(obj, filename, carry) {\n        let add = new ADD({\n            name: obj.Name,\n            description: obj.Description,\n            author: \"IEM Graz\",\n        });\n        let date_str = obj.Description.split(\".\")[obj.Description.split(\".\").length - 1].trim();\n        let ampm = date_str.slice(-2);\n        let date = new Date(date_str.slice(0, -2));\n        date.setHours(date.getHours() + ((ampm == 'pm') ? 12 : 0));\n        add.setDate(date);\n        add.addMatrix(new Matrix(0, obj.Decoder.ExpectedInputNormalization, obj.Decoder.Matrix));\n        let num_outputs = obj.LoudspeakerLayout.Loudspeakers\n            .reduce((val, spk) => val + +!spk.IsImaginary, 0);\n        let num_imags = obj.LoudspeakerLayout.Loudspeakers\n            .reduce((val, spk) => val + spk.IsImaginary, 0);\n        add.decoder.output.matrix = [];\n        for (let i = 0; i < obj.LoudspeakerLayout.Loudspeakers.length; ++i)\n            add.decoder.output.matrix.push(new Array(num_outputs).fill(0));\n        obj.LoudspeakerLayout.Loudspeakers.forEach((speaker, index) => add.addOutput(new OutputChannel(`${obj.LoudspeakerLayout.Name} ${index}${(speaker.IsImaginary) ? \" [IMAG]\" : \"\"}`, 'spk', { coords: new AEDCoord(speaker.Azimuth, speaker.Elevation, speaker.Radius) })));\n        obj.Decoder.Routing.forEach((ch, index) => {\n            add.decoder.output.matrix[ch - 1][index]\n                = obj.LoudspeakerLayout.Loudspeakers[ch - 1].Gain;\n        });\n        if (add.valid())\n            carry.results.push(add);\n        else\n            carry.incomplete_results.push(add);\n    }\n    static fromADD(add, opts) {\n        let iem = {\n            Name: add.name,\n            Description: add.description,\n            Decoder: {\n                Name: add.name,\n                Description: add.description,\n                ExpectedInputNormalization: add.decoder.matrices[0].getNormalisation(),\n                Weights: \"maxrE\",\n                WeightsAlreadyApplied: false,\n                Matrix: [],\n                Routing: []\n            },\n            LoudspeakerLayout: {\n                Name: \"\",\n                Loudspeakers: []\n            }\n        };\n        add.decoder.output.channels.forEach((ch, i) => {\n            let spk = {\n                Azimuth: ch.coords.a || 0,\n                Elevation: ch.coords.e || 0,\n                Radius: ch.coords.d || 1,\n                IsImaginary: isImag(add, i),\n                Channel: i + 1,\n                Gain: gainForChannel(add, i)\n            };\n            if (!isImag(add, i))\n                iem.Decoder.Routing.push(i + 1);\n            iem.LoudspeakerLayout.Loudspeakers.push(spk);\n        });\n        iem.Decoder.Matrix = add.decoder.matrices[0].matrix;\n        let prettify = opts.use('prettify');\n        if (prettify)\n            return JSON.stringify(iem, null, 4);\n        else\n            return JSON.stringify(iem);\n    }\n};\nIEMFormat = __decorate([\n    _static_implements()\n], IEMFormat);\nexport default IEMFormat;\nfunction isImag(add, index) {\n    return add.decoder.output.matrix[index]\n        .reduce((val, arr) => val + arr, 0) == 0.;\n}\nfunction gainForChannel(add, index) {\n    return add.decoder.output.matrix[index]\n        .reduce((val, arr) => val + arr, 0);\n}\n"],"file":"IEMFormat.js"}